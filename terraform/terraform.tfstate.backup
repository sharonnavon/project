{
    "version": 3,
    "terraform_version": "0.11.11",
    "serial": 32,
    "lineage": "d2e60b36-d1c9-0ca8-beea-59cd75ca4776",
    "modules": [
        {
            "path": [
                "root"
            ],
            "outputs": {
                "Consul": {
                    "sensitive": false,
                    "type": "string",
                    "value": "http://52.90.87.196:8500"
                },
                "DummyExporterService1": {
                    "sensitive": false,
                    "type": "string",
                    "value": "curl http://100.26.97.172:65433"
                },
                "DummyExporterService2": {
                    "sensitive": false,
                    "type": "string",
                    "value": "curl http://18.212.176.147:65433"
                },
                "ElasticSearch": {
                    "sensitive": false,
                    "type": "string",
                    "value": "curl http://35.174.139.117:9200"
                },
                "Grafana": {
                    "sensitive": false,
                    "type": "string",
                    "value": "http://18.212.186.62:3000"
                },
                "Kibana": {
                    "sensitive": false,
                    "type": "string",
                    "value": "curl http://35.174.139.117:5601/app/infra#/logs"
                },
                "Prometheus": {
                    "sensitive": false,
                    "type": "string",
                    "value": "curl http://3.95.135.208:9090"
                }
            },
            "resources": {
                "aws_iam_instance_profile.consul_auto_join": {
                    "type": "aws_iam_instance_profile",
                    "depends_on": [
                        "aws_iam_role.consul_auto_join"
                    ],
                    "primary": {
                        "id": "consul_auto_join",
                        "attributes": {
                            "arn": "arn:aws:iam::230617609085:instance-profile/consul_auto_join",
                            "create_date": "2019-02-13T13:45:47Z",
                            "id": "consul_auto_join",
                            "name": "consul_auto_join",
                            "path": "/",
                            "role": "consul_auto_join",
                            "roles.#": "1",
                            "roles.4186901782": "consul_auto_join",
                            "unique_id": "AIPAIZG7WY6TDGWWS3PXC"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_iam_policy.consul_auto_join": {
                    "type": "aws_iam_policy",
                    "depends_on": [],
                    "primary": {
                        "id": "arn:aws:iam::230617609085:policy/consul_auto_join",
                        "attributes": {
                            "arn": "arn:aws:iam::230617609085:policy/consul_auto_join",
                            "description": "Allows Consul nodes to describe instances for joining",
                            "id": "arn:aws:iam::230617609085:policy/consul_auto_join",
                            "name": "consul_auto_join",
                            "path": "/",
                            "policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": \"ec2:DescribeInstances\",\n      \"Resource\": \"*\"\n    }\n  ]\n}\n"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_iam_policy_attachment.consul_auto_join": {
                    "type": "aws_iam_policy_attachment",
                    "depends_on": [
                        "aws_iam_policy.consul_auto_join",
                        "aws_iam_role.consul_auto_join"
                    ],
                    "primary": {
                        "id": "consul_auto_join",
                        "attributes": {
                            "groups.#": "0",
                            "id": "consul_auto_join",
                            "name": "consul_auto_join",
                            "policy_arn": "arn:aws:iam::230617609085:policy/consul_auto_join",
                            "roles.#": "1",
                            "roles.4186901782": "consul_auto_join",
                            "users.#": "0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_iam_role.consul_auto_join": {
                    "type": "aws_iam_role",
                    "depends_on": [],
                    "primary": {
                        "id": "consul_auto_join",
                        "attributes": {
                            "arn": "arn:aws:iam::230617609085:role/consul_auto_join",
                            "assume_role_policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"ec2.amazonaws.com\"},\"Action\":\"sts:AssumeRole\"}]}",
                            "create_date": "2019-02-13T13:45:46Z",
                            "description": "",
                            "force_detach_policies": "false",
                            "id": "consul_auto_join",
                            "max_session_duration": "3600",
                            "name": "consul_auto_join",
                            "path": "/",
                            "tags.%": "0",
                            "unique_id": "AROAIXYQIZTOAMNMICJA6"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.consul_server.0": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_security_group.sg_consul",
                        "aws_subnet.public_subnet1",
                        "data.template_file.consul_server.*"
                    ],
                    "primary": {
                        "id": "i-09f48eb00c42158e2",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-09f48eb00c42158e2",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-09f48eb00c42158e2",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-0c970a08bdf0e984a",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-0c970a08bdf0e984a",
                            "private_dns": "ip-10-0-1-21.ec2.internal",
                            "private_ip": "10.0.1.21",
                            "public_dns": "ec2-52-90-87-196.compute-1.amazonaws.com",
                            "public_ip": "52.90.87.196",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-0ffff0ffad89ae4e1",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "2",
                            "tags.Name": "consul-server1",
                            "tags.consul_server": "true",
                            "tenancy": "default",
                            "user_data": "bc6fe765ca912bae3be622c5e62a804860a372ca",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "1",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.consul_server.1": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_security_group.sg_consul",
                        "aws_subnet.public_subnet1",
                        "data.template_file.consul_server.*"
                    ],
                    "primary": {
                        "id": "i-01f0931e301d1645f",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-01f0931e301d1645f",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-01f0931e301d1645f",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-05ffb1cff09354741",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-05ffb1cff09354741",
                            "private_dns": "ip-10-0-1-126.ec2.internal",
                            "private_ip": "10.0.1.126",
                            "public_dns": "ec2-52-91-200-233.compute-1.amazonaws.com",
                            "public_ip": "52.91.200.233",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-04480803fb62920ae",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "2",
                            "tags.Name": "consul-server2",
                            "tags.consul_server": "true",
                            "tenancy": "default",
                            "user_data": "7c827317c30cdfc15e6822784513f1850c229344",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "1",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.consul_server.2": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_security_group.sg_consul",
                        "aws_subnet.public_subnet1",
                        "data.template_file.consul_server.*"
                    ],
                    "primary": {
                        "id": "i-0b7a356cb302f356d",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-0b7a356cb302f356d",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-0b7a356cb302f356d",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-03b14da796b44c507",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-03b14da796b44c507",
                            "private_dns": "ip-10-0-1-60.ec2.internal",
                            "private_ip": "10.0.1.60",
                            "public_dns": "ec2-34-226-142-86.compute-1.amazonaws.com",
                            "public_ip": "34.226.142.86",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-04bd8679fbcc5ff99",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "2",
                            "tags.Name": "consul-server3",
                            "tags.consul_server": "true",
                            "tenancy": "default",
                            "user_data": "2c38190005a07ba79f6e0dec602423cffadc99c6",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "1",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.docker_server.0": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_instance.consul_server",
                        "aws_instance.elk",
                        "aws_instance.prometheus",
                        "aws_security_group.sg_consul",
                        "aws_security_group.sg_default",
                        "aws_subnet.public_subnet1",
                        "data.template_cloudinit_config.docker_server_config.*"
                    ],
                    "primary": {
                        "id": "i-0648b626dd013f03e",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-0648b626dd013f03e",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-0648b626dd013f03e",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-098e1e6153291812d",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-098e1e6153291812d",
                            "private_dns": "ip-10-0-1-112.ec2.internal",
                            "private_ip": "10.0.1.112",
                            "public_dns": "ec2-100-26-97-172.compute-1.amazonaws.com",
                            "public_ip": "100.26.97.172",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-0dfaef98ad42d16dd",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "1",
                            "tags.Name": "docker-server1",
                            "tenancy": "default",
                            "user_data": "2357445239748a6c1fe12e52a69bb4636b18540d",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d",
                            "vpc_security_group_ids.4023061101": "sg-0c2ff24e2c07efc22"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.docker_server.1": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_instance.consul_server",
                        "aws_instance.elk",
                        "aws_instance.prometheus",
                        "aws_security_group.sg_consul",
                        "aws_security_group.sg_default",
                        "aws_subnet.public_subnet1",
                        "data.template_cloudinit_config.docker_server_config.*"
                    ],
                    "primary": {
                        "id": "i-0d5988c46d6b32312",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-0d5988c46d6b32312",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-0d5988c46d6b32312",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-0f5442ddf0c9a92e4",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-0f5442ddf0c9a92e4",
                            "private_dns": "ip-10-0-1-198.ec2.internal",
                            "private_ip": "10.0.1.198",
                            "public_dns": "ec2-18-212-176-147.compute-1.amazonaws.com",
                            "public_ip": "18.212.176.147",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-0a1c108aeafaea69b",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "1",
                            "tags.Name": "docker-server2",
                            "tenancy": "default",
                            "user_data": "8975c030ed9ad02f918f0c6365d89a6be0d4e4c5",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d",
                            "vpc_security_group_ids.4023061101": "sg-0c2ff24e2c07efc22"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.elk": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_instance.consul_server",
                        "aws_security_group.sg_consul",
                        "aws_security_group.sg_default",
                        "aws_subnet.public_subnet1",
                        "data.template_cloudinit_config.elk_config"
                    ],
                    "primary": {
                        "id": "i-0b39dde35ea402d93",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-0b39dde35ea402d93",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "2",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "unlimited",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-0b39dde35ea402d93",
                            "instance_state": "running",
                            "instance_type": "t3.medium",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-04fe3e9807d98ede6",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-04fe3e9807d98ede6",
                            "private_dns": "ip-10-0-1-207.ec2.internal",
                            "private_ip": "10.0.1.207",
                            "public_dns": "ec2-35-174-139-117.compute-1.amazonaws.com",
                            "public_ip": "35.174.139.117",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-0e70beab76b58f3a5",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "1",
                            "tags.Name": "elk",
                            "tenancy": "default",
                            "user_data": "fcdf819a0b45457c7bde5bf91e2aac77b197b68f",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d",
                            "vpc_security_group_ids.4023061101": "sg-0c2ff24e2c07efc22"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.grafana": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_instance.consul_server",
                        "aws_instance.prometheus",
                        "aws_security_group.sg_consul",
                        "aws_security_group.sg_default",
                        "aws_subnet.public_subnet1",
                        "data.template_cloudinit_config.grafana_config"
                    ],
                    "primary": {
                        "id": "i-005ceca92482da265",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-005ceca92482da265",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-005ceca92482da265",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-05588e9b9b193495d",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-05588e9b9b193495d",
                            "private_dns": "ip-10-0-1-41.ec2.internal",
                            "private_ip": "10.0.1.41",
                            "public_dns": "ec2-18-212-186-62.compute-1.amazonaws.com",
                            "public_ip": "18.212.186.62",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-02b6ea70b77c04162",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "1",
                            "tags.Name": "grafana",
                            "tenancy": "default",
                            "user_data": "4d19b206c465f48177c63fb4ba6cbaa203bb4c00",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d",
                            "vpc_security_group_ids.4023061101": "sg-0c2ff24e2c07efc22"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_instance.prometheus": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_iam_instance_profile.consul_auto_join",
                        "aws_instance.consul_server",
                        "aws_security_group.sg_consul",
                        "aws_security_group.sg_default",
                        "aws_subnet.public_subnet1",
                        "data.template_cloudinit_config.prometheus_config"
                    ],
                    "primary": {
                        "id": "i-024125d6e8b43d1df",
                        "attributes": {
                            "ami": "ami-0f9cf087c1f27d9b1",
                            "arn": "arn:aws:ec2:us-east-1:230617609085:instance/i-024125d6e8b43d1df",
                            "associate_public_ip_address": "true",
                            "availability_zone": "us-east-1a",
                            "cpu_core_count": "1",
                            "cpu_threads_per_core": "1",
                            "credit_specification.#": "1",
                            "credit_specification.0.cpu_credits": "standard",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "0",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "get_password_data": "false",
                            "iam_instance_profile": "consul_auto_join",
                            "id": "i-024125d6e8b43d1df",
                            "instance_state": "running",
                            "instance_type": "t2.micro",
                            "ipv6_addresses.#": "0",
                            "key_name": "aws_ec2",
                            "monitoring": "false",
                            "network_interface.#": "0",
                            "network_interface_id": "eni-05fd6aa06752e92a0",
                            "password_data": "",
                            "placement_group": "",
                            "primary_network_interface_id": "eni-05fd6aa06752e92a0",
                            "private_dns": "ip-10-0-1-135.ec2.internal",
                            "private_ip": "10.0.1.135",
                            "public_dns": "ec2-3-95-135-208.compute-1.amazonaws.com",
                            "public_ip": "3.95.135.208",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "true",
                            "root_block_device.0.iops": "100",
                            "root_block_device.0.volume_id": "vol-03b8ac6cfee3b112d",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "gp2",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-08b329ea3c7350afa",
                            "tags.%": "1",
                            "tags.Name": "prometheus",
                            "tenancy": "default",
                            "user_data": "b161c0861177370160ceb005d93003f6d0423126",
                            "volume_tags.%": "0",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.2107006340": "sg-026423e8d07e4168d",
                            "vpc_security_group_ids.4023061101": "sg-0c2ff24e2c07efc22"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 1200000000000,
                                "update": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_internet_gateway.igw": {
                    "type": "aws_internet_gateway",
                    "depends_on": [
                        "aws_vpc.MyVPC"
                    ],
                    "primary": {
                        "id": "igw-05dcbaeed21b08d35",
                        "attributes": {
                            "id": "igw-05dcbaeed21b08d35",
                            "owner_id": "230617609085",
                            "tags.%": "0",
                            "vpc_id": "vpc-0b020efbf034005ec"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_route_table.rtb_public": {
                    "type": "aws_route_table",
                    "depends_on": [
                        "aws_internet_gateway.igw",
                        "aws_vpc.MyVPC"
                    ],
                    "primary": {
                        "id": "rtb-0bccde740721734dc",
                        "attributes": {
                            "id": "rtb-0bccde740721734dc",
                            "owner_id": "230617609085",
                            "propagating_vgws.#": "0",
                            "route.#": "1",
                            "route.1003550417.cidr_block": "0.0.0.0/0",
                            "route.1003550417.egress_only_gateway_id": "",
                            "route.1003550417.gateway_id": "igw-05dcbaeed21b08d35",
                            "route.1003550417.instance_id": "",
                            "route.1003550417.ipv6_cidr_block": "",
                            "route.1003550417.nat_gateway_id": "",
                            "route.1003550417.network_interface_id": "",
                            "route.1003550417.transit_gateway_id": "",
                            "route.1003550417.vpc_peering_connection_id": "",
                            "tags.%": "1",
                            "tags.Name": "rtb_public",
                            "vpc_id": "vpc-0b020efbf034005ec"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_route_table_association.rta-public_subnet1": {
                    "type": "aws_route_table_association",
                    "depends_on": [
                        "aws_route_table.rtb_public",
                        "aws_subnet.public_subnet1"
                    ],
                    "primary": {
                        "id": "rtbassoc-0dca91ecc4724d767",
                        "attributes": {
                            "id": "rtbassoc-0dca91ecc4724d767",
                            "route_table_id": "rtb-0bccde740721734dc",
                            "subnet_id": "subnet-08b329ea3c7350afa"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_security_group.sg_consul": {
                    "type": "aws_security_group",
                    "depends_on": [
                        "aws_vpc.MyVPC"
                    ],
                    "primary": {
                        "id": "sg-026423e8d07e4168d",
                        "attributes": {
                            "arn": "arn:aws:ec2:us-east-1:230617609085:security-group/sg-026423e8d07e4168d",
                            "description": "Allow ssh \u0026 consul inbound traffic",
                            "egress.#": "1",
                            "egress.2049434831.cidr_blocks.#": "1",
                            "egress.2049434831.cidr_blocks.0": "0.0.0.0/0",
                            "egress.2049434831.description": "Allow all outside security group",
                            "egress.2049434831.from_port": "0",
                            "egress.2049434831.ipv6_cidr_blocks.#": "0",
                            "egress.2049434831.prefix_list_ids.#": "0",
                            "egress.2049434831.protocol": "-1",
                            "egress.2049434831.security_groups.#": "0",
                            "egress.2049434831.self": "false",
                            "egress.2049434831.to_port": "0",
                            "id": "sg-026423e8d07e4168d",
                            "ingress.#": "3",
                            "ingress.3406622939.cidr_blocks.#": "1",
                            "ingress.3406622939.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.3406622939.description": "Allow consul UI access from the world",
                            "ingress.3406622939.from_port": "8500",
                            "ingress.3406622939.ipv6_cidr_blocks.#": "0",
                            "ingress.3406622939.prefix_list_ids.#": "0",
                            "ingress.3406622939.protocol": "tcp",
                            "ingress.3406622939.security_groups.#": "0",
                            "ingress.3406622939.self": "false",
                            "ingress.3406622939.to_port": "8500",
                            "ingress.4044943731.cidr_blocks.#": "1",
                            "ingress.4044943731.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.4044943731.description": "Allow ssh from the world",
                            "ingress.4044943731.from_port": "22",
                            "ingress.4044943731.ipv6_cidr_blocks.#": "0",
                            "ingress.4044943731.prefix_list_ids.#": "0",
                            "ingress.4044943731.protocol": "tcp",
                            "ingress.4044943731.security_groups.#": "0",
                            "ingress.4044943731.self": "false",
                            "ingress.4044943731.to_port": "22",
                            "ingress.994307033.cidr_blocks.#": "0",
                            "ingress.994307033.description": "Allow all inside security group",
                            "ingress.994307033.from_port": "0",
                            "ingress.994307033.ipv6_cidr_blocks.#": "0",
                            "ingress.994307033.prefix_list_ids.#": "0",
                            "ingress.994307033.protocol": "-1",
                            "ingress.994307033.security_groups.#": "0",
                            "ingress.994307033.self": "true",
                            "ingress.994307033.to_port": "0",
                            "name": "sg_consul",
                            "owner_id": "230617609085",
                            "revoke_rules_on_delete": "false",
                            "tags.%": "0",
                            "vpc_id": "vpc-0b020efbf034005ec"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_security_group.sg_default": {
                    "type": "aws_security_group",
                    "depends_on": [
                        "aws_vpc.MyVPC"
                    ],
                    "primary": {
                        "id": "sg-0c2ff24e2c07efc22",
                        "attributes": {
                            "arn": "arn:aws:ec2:us-east-1:230617609085:security-group/sg-0c2ff24e2c07efc22",
                            "description": "Managed by Terraform",
                            "egress.#": "1",
                            "egress.482069346.cidr_blocks.#": "1",
                            "egress.482069346.cidr_blocks.0": "0.0.0.0/0",
                            "egress.482069346.description": "",
                            "egress.482069346.from_port": "0",
                            "egress.482069346.ipv6_cidr_blocks.#": "0",
                            "egress.482069346.prefix_list_ids.#": "0",
                            "egress.482069346.protocol": "-1",
                            "egress.482069346.security_groups.#": "0",
                            "egress.482069346.self": "false",
                            "egress.482069346.to_port": "0",
                            "id": "sg-0c2ff24e2c07efc22",
                            "ingress.#": "11",
                            "ingress.1746620816.cidr_blocks.#": "1",
                            "ingress.1746620816.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.1746620816.description": "",
                            "ingress.1746620816.from_port": "9100",
                            "ingress.1746620816.ipv6_cidr_blocks.#": "0",
                            "ingress.1746620816.prefix_list_ids.#": "0",
                            "ingress.1746620816.protocol": "tcp",
                            "ingress.1746620816.security_groups.#": "0",
                            "ingress.1746620816.self": "false",
                            "ingress.1746620816.to_port": "9100",
                            "ingress.1994621032.cidr_blocks.#": "1",
                            "ingress.1994621032.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.1994621032.description": "",
                            "ingress.1994621032.from_port": "3000",
                            "ingress.1994621032.ipv6_cidr_blocks.#": "0",
                            "ingress.1994621032.prefix_list_ids.#": "0",
                            "ingress.1994621032.protocol": "tcp",
                            "ingress.1994621032.security_groups.#": "0",
                            "ingress.1994621032.self": "false",
                            "ingress.1994621032.to_port": "3000",
                            "ingress.2214680975.cidr_blocks.#": "1",
                            "ingress.2214680975.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.2214680975.description": "",
                            "ingress.2214680975.from_port": "80",
                            "ingress.2214680975.ipv6_cidr_blocks.#": "0",
                            "ingress.2214680975.prefix_list_ids.#": "0",
                            "ingress.2214680975.protocol": "tcp",
                            "ingress.2214680975.security_groups.#": "0",
                            "ingress.2214680975.self": "false",
                            "ingress.2214680975.to_port": "80",
                            "ingress.2319052179.cidr_blocks.#": "1",
                            "ingress.2319052179.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.2319052179.description": "",
                            "ingress.2319052179.from_port": "9000",
                            "ingress.2319052179.ipv6_cidr_blocks.#": "0",
                            "ingress.2319052179.prefix_list_ids.#": "0",
                            "ingress.2319052179.protocol": "tcp",
                            "ingress.2319052179.security_groups.#": "0",
                            "ingress.2319052179.self": "false",
                            "ingress.2319052179.to_port": "9000",
                            "ingress.2500694996.cidr_blocks.#": "1",
                            "ingress.2500694996.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.2500694996.description": "",
                            "ingress.2500694996.from_port": "9200",
                            "ingress.2500694996.ipv6_cidr_blocks.#": "0",
                            "ingress.2500694996.prefix_list_ids.#": "0",
                            "ingress.2500694996.protocol": "tcp",
                            "ingress.2500694996.security_groups.#": "0",
                            "ingress.2500694996.self": "false",
                            "ingress.2500694996.to_port": "9200",
                            "ingress.2541437006.cidr_blocks.#": "1",
                            "ingress.2541437006.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.2541437006.description": "",
                            "ingress.2541437006.from_port": "22",
                            "ingress.2541437006.ipv6_cidr_blocks.#": "0",
                            "ingress.2541437006.prefix_list_ids.#": "0",
                            "ingress.2541437006.protocol": "tcp",
                            "ingress.2541437006.security_groups.#": "0",
                            "ingress.2541437006.self": "false",
                            "ingress.2541437006.to_port": "22",
                            "ingress.2937129820.cidr_blocks.#": "1",
                            "ingress.2937129820.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.2937129820.description": "",
                            "ingress.2937129820.from_port": "5044",
                            "ingress.2937129820.ipv6_cidr_blocks.#": "0",
                            "ingress.2937129820.prefix_list_ids.#": "0",
                            "ingress.2937129820.protocol": "tcp",
                            "ingress.2937129820.security_groups.#": "0",
                            "ingress.2937129820.self": "false",
                            "ingress.2937129820.to_port": "5044",
                            "ingress.3431095222.cidr_blocks.#": "1",
                            "ingress.3431095222.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.3431095222.description": "",
                            "ingress.3431095222.from_port": "5601",
                            "ingress.3431095222.ipv6_cidr_blocks.#": "0",
                            "ingress.3431095222.prefix_list_ids.#": "0",
                            "ingress.3431095222.protocol": "tcp",
                            "ingress.3431095222.security_groups.#": "0",
                            "ingress.3431095222.self": "false",
                            "ingress.3431095222.to_port": "5601",
                            "ingress.476094592.cidr_blocks.#": "1",
                            "ingress.476094592.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.476094592.description": "",
                            "ingress.476094592.from_port": "65433",
                            "ingress.476094592.ipv6_cidr_blocks.#": "0",
                            "ingress.476094592.prefix_list_ids.#": "0",
                            "ingress.476094592.protocol": "tcp",
                            "ingress.476094592.security_groups.#": "0",
                            "ingress.476094592.self": "false",
                            "ingress.476094592.to_port": "65433",
                            "ingress.501830036.cidr_blocks.#": "1",
                            "ingress.501830036.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.501830036.description": "",
                            "ingress.501830036.from_port": "9090",
                            "ingress.501830036.ipv6_cidr_blocks.#": "0",
                            "ingress.501830036.prefix_list_ids.#": "0",
                            "ingress.501830036.protocol": "tcp",
                            "ingress.501830036.security_groups.#": "0",
                            "ingress.501830036.self": "false",
                            "ingress.501830036.to_port": "9090",
                            "ingress.516175195.cidr_blocks.#": "1",
                            "ingress.516175195.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.516175195.description": "",
                            "ingress.516175195.from_port": "8080",
                            "ingress.516175195.ipv6_cidr_blocks.#": "0",
                            "ingress.516175195.prefix_list_ids.#": "0",
                            "ingress.516175195.protocol": "tcp",
                            "ingress.516175195.security_groups.#": "0",
                            "ingress.516175195.self": "false",
                            "ingress.516175195.to_port": "8080",
                            "name": "sg_default",
                            "owner_id": "230617609085",
                            "revoke_rules_on_delete": "false",
                            "tags.%": "0",
                            "vpc_id": "vpc-0b020efbf034005ec"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_subnet.public_subnet1": {
                    "type": "aws_subnet",
                    "depends_on": [
                        "aws_vpc.MyVPC",
                        "data.aws_availability_zones.available"
                    ],
                    "primary": {
                        "id": "subnet-08b329ea3c7350afa",
                        "attributes": {
                            "arn": "arn:aws:ec2:us-east-1:230617609085:subnet/subnet-08b329ea3c7350afa",
                            "assign_ipv6_address_on_creation": "false",
                            "availability_zone": "us-east-1a",
                            "availability_zone_id": "use1-az2",
                            "cidr_block": "10.0.1.0/24",
                            "id": "subnet-08b329ea3c7350afa",
                            "ipv6_cidr_block": "",
                            "ipv6_cidr_block_association_id": "",
                            "map_public_ip_on_launch": "true",
                            "owner_id": "230617609085",
                            "tags.%": "1",
                            "tags.Name": "public_subnet1",
                            "vpc_id": "vpc-0b020efbf034005ec"
                        },
                        "meta": {
                            "e2bfb730-ecaa-11e6-8f88-34363bc7c4c0": {
                                "create": 600000000000,
                                "delete": 600000000000
                            },
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "aws_vpc.MyVPC": {
                    "type": "aws_vpc",
                    "depends_on": [],
                    "primary": {
                        "id": "vpc-0b020efbf034005ec",
                        "attributes": {
                            "arn": "arn:aws:ec2:us-east-1:230617609085:vpc/vpc-0b020efbf034005ec",
                            "assign_generated_ipv6_cidr_block": "false",
                            "cidr_block": "10.0.0.0/16",
                            "default_network_acl_id": "acl-0755b8bdcfe4d7bb2",
                            "default_route_table_id": "rtb-0dca35ee80eda3cff",
                            "default_security_group_id": "sg-00c9fb3ce9631459d",
                            "dhcp_options_id": "dopt-e3c88598",
                            "enable_classiclink": "false",
                            "enable_classiclink_dns_support": "false",
                            "enable_dns_hostnames": "true",
                            "enable_dns_support": "true",
                            "id": "vpc-0b020efbf034005ec",
                            "instance_tenancy": "default",
                            "ipv6_association_id": "",
                            "ipv6_cidr_block": "",
                            "main_route_table_id": "rtb-0dca35ee80eda3cff",
                            "owner_id": "230617609085",
                            "tags.%": "1",
                            "tags.Name": "MyVPC"
                        },
                        "meta": {
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "data.aws_availability_zones.available": {
                    "type": "aws_availability_zones",
                    "depends_on": [],
                    "primary": {
                        "id": "2019-02-13 14:44:13.716189947 +0000 UTC",
                        "attributes": {
                            "id": "2019-02-13 14:44:13.716189947 +0000 UTC",
                            "names.#": "6",
                            "names.0": "us-east-1a",
                            "names.1": "us-east-1b",
                            "names.2": "us-east-1c",
                            "names.3": "us-east-1d",
                            "names.4": "us-east-1e",
                            "names.5": "us-east-1f",
                            "zone_ids.#": "6",
                            "zone_ids.0": "use1-az2",
                            "zone_ids.1": "use1-az4",
                            "zone_ids.2": "use1-az6",
                            "zone_ids.3": "use1-az1",
                            "zone_ids.4": "use1-az3",
                            "zone_ids.5": "use1-az5"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "data.template_cloudinit_config.docker_server_config.0": {
                    "type": "template_cloudinit_config",
                    "depends_on": [
                        "data.template_file.consul_client_docker.*",
                        "data.template_file.docker_install"
                    ],
                    "primary": {
                        "id": "1069991183",
                        "attributes": {
                            "base64_encode": "true",
                            "gzip": "true",
                            "id": "1069991183",
                            "part.#": "2",
                            "part.0.content": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"docker-server1\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "part.0.content_type": "",
                            "part.0.filename": "",
                            "part.0.merge_type": "",
                            "part.1.content": "#!/usr/bin/env bash\n\n# Install Docker-ce\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"\nsudo apt -qq update \u0026\u003e /dev/null\nsudo apt install -yqq apt-transport-https ca-certificates curl gnupg2 software-properties-common docker-ce \u0026\u003e /dev/null\n\n\n# Build \u0026 run the dummy container\nsudo mkdir /opt/docker\ncd /opt/docker\nsudo wget https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/Dockerfile\nsudo wget -O /opt/docker/my_dummy_exporter.py https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/my_dummy_exporter.py\nsudo docker build -t dummyapp .\nsudo docker run --name=dummyapp -v /opt/docker/my_dummy_exporter.py:/tmp/my_dummy_exporter.py -d -p 65433:65433 dummyapp\n\n\n# Register the dummy app in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/dummy-app.json\n{\n  \"service\": {\n    \"name\": \"dummy-app\",\n    \"id\": \"dummy-app\",\n    \"port\": 65433,\n    \"check\": {\n      \"name\": \"dummy_app port 65433 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:65433\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n\n\n# Build \u0026 run the filebeat container\ncat \u003c\u003c EOF | sudo tee /opt/docker/filebeat.yml\nfilebeat.config:\n  prospectors:\n    path: /usr/share/filebeat/prospectors.d/*.yml\n    reload.enabled: false\n  modules:\n    path: /usr/share/filebeat/modules.d/*.yml\n    reload.enabled: false\n\nfilebeat.autodiscover:\n  providers:\n    - type: docker\n      hints.enabled: true\n\nprocessors:\n- add_cloud_metadata: ~\n\noutput.logstash:\n  hosts: [\"10.0.1.207:5044\"]\n\nsetup.kibana:\n  host: \"10.0.1.207:5601\"\n\nEOF\n\n\nsudo docker run -d \\\n  --name=filebeat \\\n  --user=root \\\n  -v /opt/docker/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  docker.elastic.co/beats/filebeat:6.5.4 filebeat -e -strict.perms=false\n",
                            "part.1.content_type": "",
                            "part.1.filename": "",
                            "part.1.merge_type": "",
                            "rendered": "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"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_cloudinit_config.docker_server_config.1": {
                    "type": "template_cloudinit_config",
                    "depends_on": [
                        "data.template_file.consul_client_docker.*",
                        "data.template_file.docker_install"
                    ],
                    "primary": {
                        "id": "2626608471",
                        "attributes": {
                            "base64_encode": "true",
                            "gzip": "true",
                            "id": "2626608471",
                            "part.#": "2",
                            "part.0.content": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"docker-server2\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "part.0.content_type": "",
                            "part.0.filename": "",
                            "part.0.merge_type": "",
                            "part.1.content": "#!/usr/bin/env bash\n\n# Install Docker-ce\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"\nsudo apt -qq update \u0026\u003e /dev/null\nsudo apt install -yqq apt-transport-https ca-certificates curl gnupg2 software-properties-common docker-ce \u0026\u003e /dev/null\n\n\n# Build \u0026 run the dummy container\nsudo mkdir /opt/docker\ncd /opt/docker\nsudo wget https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/Dockerfile\nsudo wget -O /opt/docker/my_dummy_exporter.py https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/my_dummy_exporter.py\nsudo docker build -t dummyapp .\nsudo docker run --name=dummyapp -v /opt/docker/my_dummy_exporter.py:/tmp/my_dummy_exporter.py -d -p 65433:65433 dummyapp\n\n\n# Register the dummy app in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/dummy-app.json\n{\n  \"service\": {\n    \"name\": \"dummy-app\",\n    \"id\": \"dummy-app\",\n    \"port\": 65433,\n    \"check\": {\n      \"name\": \"dummy_app port 65433 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:65433\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n\n\n# Build \u0026 run the filebeat container\ncat \u003c\u003c EOF | sudo tee /opt/docker/filebeat.yml\nfilebeat.config:\n  prospectors:\n    path: /usr/share/filebeat/prospectors.d/*.yml\n    reload.enabled: false\n  modules:\n    path: /usr/share/filebeat/modules.d/*.yml\n    reload.enabled: false\n\nfilebeat.autodiscover:\n  providers:\n    - type: docker\n      hints.enabled: true\n\nprocessors:\n- add_cloud_metadata: ~\n\noutput.logstash:\n  hosts: [\"10.0.1.207:5044\"]\n\nsetup.kibana:\n  host: \"10.0.1.207:5601\"\n\nEOF\n\n\nsudo docker run -d \\\n  --name=filebeat \\\n  --user=root \\\n  -v /opt/docker/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  docker.elastic.co/beats/filebeat:6.5.4 filebeat -e -strict.perms=false\n",
                            "part.1.content_type": "",
                            "part.1.filename": "",
                            "part.1.merge_type": "",
                            "rendered": "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"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_cloudinit_config.elk_config": {
                    "type": "template_cloudinit_config",
                    "depends_on": [
                        "data.template_file.consul_client_elk"
                    ],
                    "primary": {
                        "id": "2107156146",
                        "attributes": {
                            "base64_encode": "true",
                            "gzip": "true",
                            "id": "2107156146",
                            "part.#": "2",
                            "part.0.content": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"elk\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "part.0.content_type": "",
                            "part.0.filename": "",
                            "part.0.merge_type": "",
                            "part.1.content": "#!/bin/bash\n\n# Install ELK\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\nwget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -\necho \"deb https://artifacts.elastic.co/packages/6.x/apt stable main\" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list\nsudo apt-get -qq update\nsudo apt-get install -y openjdk-8-jre-headless openjdk-8-jdk-headless\nsudo apt-get install -y elasticsearch logstash kibana\nsudo systemctl daemon-reload\nsudo systemctl enable elasticsearch logstash kibana\nsudo systemctl start elasticsearch logstash kibana\n\n\n# Configure Elasticsearch\ncat \u003c\u003c EOF | sudo tee --append /etc/elasticsearch/elasticsearch.yml\n\nnetwork.host: 0.0.0.0\nhttp.port: 9200\n\nEOF\n\n\n# Configure LogStash\ncat \u003c\u003c EOF | sudo tee /etc/logstash/conf.d/demo-metrics-pipeline.conf\ninput {\n  beats {\n    port =\u003e 5044\n  }\n}\n\n# The filter part of this file is commented out to indicate that it\n# is optional.\n# filter {\n#\n# }\n\noutput {\n  elasticsearch {\n    hosts =\u003e \"localhost:9200\"\n    manage_template =\u003e false\n    index =\u003e \"%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}\"\n  }\n}\n\nEOF\n\n\n# Configure Kibana\ncat \u003c\u003c EOF | sudo tee --append /etc/kibana/kibana.yml\n\nserver.name: kibana\nserver.host: \"0.0.0.0\"\nelasticsearch.url: \"http://localhost:9200\"\n\nEOF\n\nsudo systemctl restart kibana\n\n\n# Register in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/elasticsearch.json\n{\n  \"service\": {\n    \"name\": \"elasticsearch\",\n    \"id\": \"elasticsearch\",\n    \"port\": 9200,\n    \"check\": {\n      \"name\": \"elasticsearch port 9200 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:9200/_cluster/health?pretty=true\"\n    }\n  }\n}\n\nEOF\n\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/logstash.json\n{\n  \"service\": {\n    \"name\": \"logstash\",\n    \"id\": \"logstash\",\n    \"port\": 5044,\n    \"check\": {\n      \"name\": \"logstash port 5044 tcp check\",\n      \"interval\": \"5s\",\n      \"TCP\": \"localhost:5044\"\n    }\n  }\n}\n\nEOF\n\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/kibana.json\n{\n  \"service\": {\n    \"name\": \"kibana\",\n    \"id\": \"kibana\",\n    \"port\": 5601,\n    \"check\": {\n      \"name\": \"kibana port 5601 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:5601\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n",
                            "part.1.content_type": "",
                            "part.1.filename": "",
                            "part.1.merge_type": "",
                            "rendered": "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"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_cloudinit_config.grafana_config": {
                    "type": "template_cloudinit_config",
                    "depends_on": [
                        "data.template_file.consul_client_grafana",
                        "data.template_file.grafana_install"
                    ],
                    "primary": {
                        "id": "806787656",
                        "attributes": {
                            "base64_encode": "true",
                            "gzip": "true",
                            "id": "806787656",
                            "part.#": "2",
                            "part.0.content": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"grafana\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "part.0.content_type": "",
                            "part.0.filename": "",
                            "part.0.merge_type": "",
                            "part.1.content": "#!/bin/bash\n\n# Install Grafana\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\necho \"deb https://packages.grafana.com/oss/deb stable main\" \u003e /etc/apt/sources.list.d/grafana.list\ncurl https://packages.grafana.com/gpg.key | sudo apt-key add -\nsudo apt -qq update\nsudo apt install -y grafana\nsudo systemctl enable grafana-server.service\n\nsudo sed -i 's/;admin_user = admin/admin_user = admin/g' /etc/grafana/grafana.ini\nsudo sed -i 's/;admin_password = admin/admin_password = admin/g' /etc/grafana/grafana.ini\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/datasources/datasource.yml\napiVersion: 1\ndatasources:\n - name: Prometheus\n   type: prometheus\n   access: proxy\n   orgId: 1\n   url: http://prometheus.service.consul:9090\n#   url: http://10.0.1.135:9090\n   isDefault: true\n   version: 1\neditable: false\nEOF\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/dashboards/all.yml\napiVersion: 1\n\nproviders:\n- name: 'default'\n  orgId: 1\n  folder: ''\n  type: file\n  disableDeletion: false\n  updateIntervalSeconds: 10 #how often Grafana will scan for changed dashboards\n  options:\n    path: /var/lib/grafana/dashboards\nEOF\n\nsudo mkdir /var/lib/grafana/dashboards\ncat \u003c\u003c EOF | sudo tee /var/lib/grafana/dashboards/Dummy_Exporter_Dashboard.json\n{\n  \"annotations\": {\n    \"list\": [\n      {\n        \"builtIn\": 1,\n        \"datasource\": \"-- Grafana --\",\n        \"enable\": true,\n        \"hide\": true,\n        \"iconColor\": \"rgba(0, 211, 255, 1)\",\n        \"name\": \"Annotations \u0026 Alerts\",\n        \"type\": \"dashboard\"\n      }\n    ]\n  },\n  \"editable\": true,\n  \"gnetId\": null,\n  \"graphTooltip\": 0,\n  \"links\": [],\n  \"panels\": [\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 0\n      },\n      \"id\": 4,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_errors[2m])\",\n          \"format\": \"time_series\",\n          \"hide\": false,\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of errors per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    },\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 10\n      },\n      \"id\": 2,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_requests[2m])\",\n          \"format\": \"time_series\",\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of requests per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    }\n  ],\n  \"schemaVersion\": 16,\n  \"style\": \"dark\",\n  \"tags\": [],\n  \"templating\": {\n    \"list\": []\n  },\n  \"time\": {\n    \"from\": \"now-15m\",\n    \"to\": \"now\"\n  },\n  \"timepicker\": {\n    \"refresh_intervals\": [\n      \"5s\",\n      \"10s\",\n      \"30s\",\n      \"1m\",\n      \"5m\",\n      \"15m\",\n      \"30m\",\n      \"1h\",\n      \"2h\",\n      \"1d\"\n    ],\n    \"time_options\": [\n      \"5m\",\n      \"15m\",\n      \"1h\",\n      \"6h\",\n      \"12h\",\n      \"24h\",\n      \"2d\",\n      \"7d\",\n      \"30d\"\n    ]\n  },\n  \"timezone\": \"\",\n  \"title\": \"Dummy Exporter Dashboard\",\n  \"uid\": \"MX74Y8Qik\",\n  \"version\": 1\n}\n\nEOF\n\nsudo systemctl restart grafana-server.service\n\n\n# Register in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/grafana.json\n{\n  \"service\": {\n    \"name\": \"grafana\",\n    \"id\": \"grafana\",\n    \"port\": 3000,\n    \"check\": {\n      \"name\": \"grafana port 3000 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:3000\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n",
                            "part.1.content_type": "",
                            "part.1.filename": "",
                            "part.1.merge_type": "",
                            "rendered": "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"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_cloudinit_config.prometheus_config": {
                    "type": "template_cloudinit_config",
                    "depends_on": [
                        "data.template_file.consul_client_prometheus"
                    ],
                    "primary": {
                        "id": "2319982285",
                        "attributes": {
                            "base64_encode": "true",
                            "gzip": "true",
                            "id": "2319982285",
                            "part.#": "2",
                            "part.0.content": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"prometheus\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "part.0.content_type": "",
                            "part.0.filename": "",
                            "part.0.merge_type": "",
                            "part.1.content": "#!/bin/bash\n\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\nsudo apt -qq update\nsudo apt-get install -y prometheus\ncat \u003c\u003c EOF | sudo tee --append /etc/prometheus/prometheus.yml\n\n  - job_name: 'consul'\n    scrape_interval: 5s\n    consul_sd_configs:\n      - datacenter: opsschool\n        server: 'localhost:8500'\n\nEOF\nsudo systemctl restart prometheus\n\n# Register Prometheus in consul\ncat \u003c\u003c EOF | sudo tee  /etc/consul.d/prometheus.json\n{\n  \"service\": {\n    \"name\": \"prometheus\",\n    \"id\": \"prometheus\",\n    \"port\": 9090,\n    \"check\": {\n      \"name\": \"prometheus port 9090 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:9090\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n",
                            "part.1.content_type": "",
                            "part.1.filename": "",
                            "part.1.merge_type": "",
                            "rendered": "H4sIAAAAAAAA/7xW/08bOxL/3RL/w9xSwZ163g0ctGWPrUQhcFELRAm0VyG0ctaTxMVrL7Y3kNfX//3J+yXfCr8+JJT1zMcz45mPZ3yqlUPl6M28wBjyUjpRMOOiXDwj/y+MdKk4M/MkuOxddj9d316dnQy+B8Sv6Fc0VmgVw17Y2SJbhNJV0BZZ2DZM2TEa2lWZ5kJNYng/Em4FUDl3+OyiQjKhtsilyPE3+9v/iEpropFQEaoZjJidEosOKBKC2VRDcGHYaCTUBHp9G4ZhQPqD3teTm27a6ydv/pmVRsLUuSKOor13R+H+4UHY/EaSObQuytExypljkdQZk1QUs4N/tdZ7yjompbfPsUDFUWUCa0e25BpY4ejEB/T4CGXBmUPY+RhxnEWqlHIDM398BFFbhFL9IYo1bOPyHF029Q5PtbKlrFxlHCKXF6Q6DrVfNGS10tvwx7NxFBmUyCzacMrsVGTaFGGm86hGRnvhQdhpFmm1SKVQ5XPKcv7uwBt64cwrIdTxrrjdPGU2zTWHt88Nphbms2YJVR2rDFfVbEBkG4boyqLx1Gx64MIALSDShYuyFzXoskYT8k2dKdXaLoe4vsF/jMUk/GG1go+wOAgcH3evz8lPAhAwPkPjhMWUcW6CGII3S2YF//YQT5qUi0q5EupSmaFyWKl1YW021bpRosrMvHBeU559+nqAb7+Mzr/9p7N39P1z/7lnJknSWBGWjSSmBnPtMMVnzIIYnClxTV0zL82mmD2s6iWyGaZapQ5NLhRzuKo16Mw8/aGFCmK4CwqjZ4KjSdiTBccm6QPOk4YwFs0MTSWdMVli4o0E995M9RcozTFVLPcOvKUc3RRLGzSIAFUVqM2MKFwdqF2JxUNqH0EMYyYtVkLyi/iCkG04NejvVmnRwA5MDFMO9JNCY6eiAD2GsZYcja0r7mGM8zUqZlP9pIAOGmHc8nJZuHWSrPGoCqEiTWmwpbQPWGS4QTI7tw5z3vy25hrsBtuC7vV5QO5ulXD35Azr7AitktM1D8CFzfQMzRzYBJUjA3wshUGbKHRP2jxQraRQGDpmJujIydihaXWtkNwNa2v35NaiaSpLLowui3bR752dC4nJytHbAxSCkwFax4xLtKJjJmRpkHTVTBitclQuubi+PPl/f3B9Okz2SfcZs6FH9w0md0DHELxsNYB72NmBRZ83uQe/EsHCavJiP6nTA7QQnI5fPwjQugFQLkyy3kq8gwFKzXhS2X0Q0ndc+N9tH95cnvSu+r0z8llIORQTxWQy7F30rm7IjchRl27odDHELDkk5K5po/fkG1MO+ad5Uo1a6rnZ1qQid0Wfmi2Zk8AZ5lpRUwWxqayvEayTahNUFWkT4xnchAQ7kC24fHY1hLE2LacNWi1Lz8H12dWOLToHrmzO7CPJmIPjY+hen8OfsH4HGkjIo70Obbi1Dd06+LE2T8xwkFo/lNXddVOE3Rq2C1znTKiY1O0gWcyv/fdhJ+yEe9sf3nU65MXUmZqfiwj/lveJZ0n1LmmiQQ5UwK6NSkuRWUf3Qsz2wyia7NbJYYWLrC5NhjaUwrpFolceEa8mf9laX8k/pazwD5Xa1xK+8hnOc0kIAIUfelQ17XiR/qrt2sywAlPhp9eMyRgObSVvhwFPa/7YuOn/FJbjLobFsGunA9S1jGG3urBTbV384bDT2a3L+EoVV45KtmGAE2EdGugvxCBU2+FfzsXG1F/JgJ/89Zxv7kcQw09ST7LXhlgg+MvyQhs/yo86R51G0g7in6Qdj78ZBb+r2lM94KDe0g7UoM2933Rol3KP9bLmTbvMp7cUVKhfxP//eu2K+LbSpm3zglC6Rf4KAAD//2dBmSsfDAAA"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_client_docker.0": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "6ffdb78157e4a8ff4179acbea8c6f1cc3e0a5ec6dc86014edd0a531d1b815ce4",
                        "attributes": {
                            "id": "6ffdb78157e4a8ff4179acbea8c6f1cc3e0a5ec6dc86014edd0a531d1b815ce4",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"docker-server1\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"docker-server1\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_client_docker.1": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "4d55f5b008432cf9bcc09bac8f5c9144d3994e3c46e10d99ddf895188a0e6d94",
                        "attributes": {
                            "id": "4d55f5b008432cf9bcc09bac8f5c9144d3994e3c46e10d99ddf895188a0e6d94",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"docker-server2\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"docker-server2\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_client_elk": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "43af7e662c04432bcb449e807697f22f5749fb8ded7724ed69537a2feb3310a9",
                        "attributes": {
                            "id": "43af7e662c04432bcb449e807697f22f5749fb8ded7724ed69537a2feb3310a9",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"elk\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"elk\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_client_grafana": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "a1cb3c617cfe0be29480741102ce9235d789ec390d0f2cb0ad3c046db265870c",
                        "attributes": {
                            "id": "a1cb3c617cfe0be29480741102ce9235d789ec390d0f2cb0ad3c046db265870c",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"grafana\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"grafana\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_client_prometheus": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "d314b473adbfffe0393a375480b1f31f81fc1af7e32ffc610cb0253c3cfef24d",
                        "attributes": {
                            "id": "d314b473adbfffe0393a375480b1f31f81fc1af7e32ffc610cb0253c3cfef24d",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"prometheus\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"prometheus\",\n     \"enable_script_checks\": true,\n     \"server\": false\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_server.0": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "73aad22148a5618fe2bb7ffba8e2ce2d9a174f62a45aadaec815f23976a55821",
                        "attributes": {
                            "id": "73aad22148a5618fe2bb7ffba8e2ce2d9a174f62a45aadaec815f23976a55821",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"consul-server1\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"consul-server1\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_server.1": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "98fbc1a20969d685f426cfabd9b028bae12de6380ef20e25df39fba2aa79bd4f",
                        "attributes": {
                            "id": "98fbc1a20969d685f426cfabd9b028bae12de6380ef20e25df39fba2aa79bd4f",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"consul-server2\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"consul-server2\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.consul_server.2": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "c5177e090ebc9ba785bcb02eaedbfa7131ade60496279fcd2ffd0210776ce1ad",
                        "attributes": {
                            "id": "c5177e090ebc9ba785bcb02eaedbfa7131ade60496279fcd2ffd0210776ce1ad",
                            "rendered": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n       \"node_name\": \"consul-server3\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    \n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "template": "#!/usr/bin/env bash\nset -e\n\necho \"Grabbing IPs...\"\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\n\necho \"Installing dependencies...\"\nsudo apt-get -qq update \u0026\u003e/dev/null\nsudo apt-get -yqq install unzip \u0026\u003e/dev/null\n\necho \"Fetching Consul...\"\ncd /tmp\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\n\necho \"Installing Consul...\"\nunzip consul.zip \u003e/dev/null\nsudo chmod +x consul\nsudo mv consul /usr/local/bin/consul\n\n# Setup Consul\nsudo mkdir -p /opt/consul\nsudo mkdir -p /etc/consul.d\nsudo mkdir -p /run/consul\nsudo tee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\n{\n  \"advertise_addr\": \"$PRIVATE_IP\",\n  \"data_dir\": \"/opt/consul\",\n  \"datacenter\": \"opsschool\",\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\n  \"disable_remote_exec\": true,\n  \"disable_update_check\": true,\n  \"leave_on_terminate\": true,\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\n  ${config}\n}\nEOF\n\n# Create user \u0026 grant ownership of folders\nsudo useradd consul\nsudo chown -R consul:consul /opt/consul /etc/consul.d /run/consul\n\n\n# Configure consul service\nsudo tee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\n[Unit]\nDescription=Consul service discovery agent\nRequires=network-online.target\nAfter=network.target\n\n[Service]\nUser=consul\nGroup=consul\nPIDFile=/run/consul/consul.pid\nRestart=on-failure\nEnvironment=GOMAXPROCS=2\nExecStartPre=[ -f \"/run/consul/consul.pid\" ] \u0026\u0026 /usr/bin/rm -f /run/consul/consul.pid\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGINT\nTimeoutStopSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n\nsudo systemctl daemon-reload\nsudo systemctl enable consul.service\nsudo systemctl start consul.service\n\n\n# Install \u0026 configure DNS for consul resolution\nsudo apt-get install -y dnsmasq\ncat \u003c\u003c EOF | sudo tee /etc/dnsmasq.d/10-consul\n# Enable forward lookup of the 'consul' domain:\nserver=/consul/127.0.0.1#8600\n\nEOF\n\nsudo systemctl restart dnsmasq\n",
                            "vars.%": "2",
                            "vars.config": "     \"node_name\": \"consul-server3\",\n     \"server\": true,\n     \"bootstrap_expect\": 3,\n     \"ui\": true,\n     \"client_addr\": \"0.0.0.0\"\n    ",
                            "vars.consul_version": "1.4.0"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.docker_install": {
                    "type": "template_file",
                    "depends_on": [
                        "aws_instance.elk"
                    ],
                    "primary": {
                        "id": "c9e1abdceb263fd8e816e6864668c7a714d316fc2c62b717589a0ea8d8ebc588",
                        "attributes": {
                            "id": "c9e1abdceb263fd8e816e6864668c7a714d316fc2c62b717589a0ea8d8ebc588",
                            "rendered": "#!/usr/bin/env bash\n\n# Install Docker-ce\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"\nsudo apt -qq update \u0026\u003e /dev/null\nsudo apt install -yqq apt-transport-https ca-certificates curl gnupg2 software-properties-common docker-ce \u0026\u003e /dev/null\n\n\n# Build \u0026 run the dummy container\nsudo mkdir /opt/docker\ncd /opt/docker\nsudo wget https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/Dockerfile\nsudo wget -O /opt/docker/my_dummy_exporter.py https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/my_dummy_exporter.py\nsudo docker build -t dummyapp .\nsudo docker run --name=dummyapp -v /opt/docker/my_dummy_exporter.py:/tmp/my_dummy_exporter.py -d -p 65433:65433 dummyapp\n\n\n# Register the dummy app in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/dummy-app.json\n{\n  \"service\": {\n    \"name\": \"dummy-app\",\n    \"id\": \"dummy-app\",\n    \"port\": 65433,\n    \"check\": {\n      \"name\": \"dummy_app port 65433 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:65433\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n\n\n# Build \u0026 run the filebeat container\ncat \u003c\u003c EOF | sudo tee /opt/docker/filebeat.yml\nfilebeat.config:\n  prospectors:\n    path: /usr/share/filebeat/prospectors.d/*.yml\n    reload.enabled: false\n  modules:\n    path: /usr/share/filebeat/modules.d/*.yml\n    reload.enabled: false\n\nfilebeat.autodiscover:\n  providers:\n    - type: docker\n      hints.enabled: true\n\nprocessors:\n- add_cloud_metadata: ~\n\noutput.logstash:\n  hosts: [\"10.0.1.207:5044\"]\n\nsetup.kibana:\n  host: \"10.0.1.207:5601\"\n\nEOF\n\n\nsudo docker run -d \\\n  --name=filebeat \\\n  --user=root \\\n  -v /opt/docker/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  docker.elastic.co/beats/filebeat:6.5.4 filebeat -e -strict.perms=false\n",
                            "template": "#!/usr/bin/env bash\n\n# Install Docker-ce\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\nsudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"\nsudo apt -qq update \u0026\u003e /dev/null\nsudo apt install -yqq apt-transport-https ca-certificates curl gnupg2 software-properties-common docker-ce \u0026\u003e /dev/null\n\n\n# Build \u0026 run the dummy container\nsudo mkdir /opt/docker\ncd /opt/docker\nsudo wget https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/Dockerfile\nsudo wget -O /opt/docker/my_dummy_exporter.py https://raw.githubusercontent.com/sharonnavon/project/master/terraform/templates/my_dummy_exporter.py\nsudo docker build -t dummyapp .\nsudo docker run --name=dummyapp -v /opt/docker/my_dummy_exporter.py:/tmp/my_dummy_exporter.py -d -p 65433:65433 dummyapp\n\n\n# Register the dummy app in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/dummy-app.json\n{\n  \"service\": {\n    \"name\": \"dummy-app\",\n    \"id\": \"dummy-app\",\n    \"port\": 65433,\n    \"check\": {\n      \"name\": \"dummy_app port 65433 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:65433\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n\n\n# Build \u0026 run the filebeat container\ncat \u003c\u003c EOF | sudo tee /opt/docker/filebeat.yml\nfilebeat.config:\n  prospectors:\n    path: /usr/share/filebeat/prospectors.d/*.yml\n    reload.enabled: false\n  modules:\n    path: /usr/share/filebeat/modules.d/*.yml\n    reload.enabled: false\n\nfilebeat.autodiscover:\n  providers:\n    - type: docker\n      hints.enabled: true\n\nprocessors:\n- add_cloud_metadata: ~\n\noutput.logstash:\n  hosts: [\"${elk_priv_ip}:5044\"]\n\nsetup.kibana:\n  host: \"${elk_priv_ip}:5601\"\n\nEOF\n\n\nsudo docker run -d \\\n  --name=filebeat \\\n  --user=root \\\n  -v /opt/docker/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  docker.elastic.co/beats/filebeat:6.5.4 filebeat -e -strict.perms=false\n",
                            "vars.%": "1",
                            "vars.elk_priv_ip": "10.0.1.207"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                },
                "data.template_file.grafana_install": {
                    "type": "template_file",
                    "depends_on": [
                        "aws_instance.prometheus"
                    ],
                    "primary": {
                        "id": "22baca1003779c66c735790b57d547af94c5b414c8a52a3014f34d3bff935896",
                        "attributes": {
                            "id": "22baca1003779c66c735790b57d547af94c5b414c8a52a3014f34d3bff935896",
                            "rendered": "#!/bin/bash\n\n# Install Grafana\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\necho \"deb https://packages.grafana.com/oss/deb stable main\" \u003e /etc/apt/sources.list.d/grafana.list\ncurl https://packages.grafana.com/gpg.key | sudo apt-key add -\nsudo apt -qq update\nsudo apt install -y grafana\nsudo systemctl enable grafana-server.service\n\nsudo sed -i 's/;admin_user = admin/admin_user = admin/g' /etc/grafana/grafana.ini\nsudo sed -i 's/;admin_password = admin/admin_password = admin/g' /etc/grafana/grafana.ini\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/datasources/datasource.yml\napiVersion: 1\ndatasources:\n - name: Prometheus\n   type: prometheus\n   access: proxy\n   orgId: 1\n   url: http://prometheus.service.consul:9090\n#   url: http://10.0.1.135:9090\n   isDefault: true\n   version: 1\neditable: false\nEOF\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/dashboards/all.yml\napiVersion: 1\n\nproviders:\n- name: 'default'\n  orgId: 1\n  folder: ''\n  type: file\n  disableDeletion: false\n  updateIntervalSeconds: 10 #how often Grafana will scan for changed dashboards\n  options:\n    path: /var/lib/grafana/dashboards\nEOF\n\nsudo mkdir /var/lib/grafana/dashboards\ncat \u003c\u003c EOF | sudo tee /var/lib/grafana/dashboards/Dummy_Exporter_Dashboard.json\n{\n  \"annotations\": {\n    \"list\": [\n      {\n        \"builtIn\": 1,\n        \"datasource\": \"-- Grafana --\",\n        \"enable\": true,\n        \"hide\": true,\n        \"iconColor\": \"rgba(0, 211, 255, 1)\",\n        \"name\": \"Annotations \u0026 Alerts\",\n        \"type\": \"dashboard\"\n      }\n    ]\n  },\n  \"editable\": true,\n  \"gnetId\": null,\n  \"graphTooltip\": 0,\n  \"links\": [],\n  \"panels\": [\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 0\n      },\n      \"id\": 4,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_errors[2m])\",\n          \"format\": \"time_series\",\n          \"hide\": false,\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of errors per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    },\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 10\n      },\n      \"id\": 2,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_requests[2m])\",\n          \"format\": \"time_series\",\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of requests per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    }\n  ],\n  \"schemaVersion\": 16,\n  \"style\": \"dark\",\n  \"tags\": [],\n  \"templating\": {\n    \"list\": []\n  },\n  \"time\": {\n    \"from\": \"now-15m\",\n    \"to\": \"now\"\n  },\n  \"timepicker\": {\n    \"refresh_intervals\": [\n      \"5s\",\n      \"10s\",\n      \"30s\",\n      \"1m\",\n      \"5m\",\n      \"15m\",\n      \"30m\",\n      \"1h\",\n      \"2h\",\n      \"1d\"\n    ],\n    \"time_options\": [\n      \"5m\",\n      \"15m\",\n      \"1h\",\n      \"6h\",\n      \"12h\",\n      \"24h\",\n      \"2d\",\n      \"7d\",\n      \"30d\"\n    ]\n  },\n  \"timezone\": \"\",\n  \"title\": \"Dummy Exporter Dashboard\",\n  \"uid\": \"MX74Y8Qik\",\n  \"version\": 1\n}\n\nEOF\n\nsudo systemctl restart grafana-server.service\n\n\n# Register in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/grafana.json\n{\n  \"service\": {\n    \"name\": \"grafana\",\n    \"id\": \"grafana\",\n    \"port\": 3000,\n    \"check\": {\n      \"name\": \"grafana port 3000 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:3000\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n",
                            "template": "#!/bin/bash\n\n# Install Grafana\nsudo sed -i 's/us-east-1.ec2.//g' /etc/apt/sources.list\necho \"deb https://packages.grafana.com/oss/deb stable main\" \u003e /etc/apt/sources.list.d/grafana.list\ncurl https://packages.grafana.com/gpg.key | sudo apt-key add -\nsudo apt -qq update\nsudo apt install -y grafana\nsudo systemctl enable grafana-server.service\n\nsudo sed -i 's/;admin_user = admin/admin_user = admin/g' /etc/grafana/grafana.ini\nsudo sed -i 's/;admin_password = admin/admin_password = admin/g' /etc/grafana/grafana.ini\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/datasources/datasource.yml\napiVersion: 1\ndatasources:\n - name: Prometheus\n   type: prometheus\n   access: proxy\n   orgId: 1\n   url: http://prometheus.service.consul:9090\n#   url: http://${prom_priv_ip}:9090\n   isDefault: true\n   version: 1\neditable: false\nEOF\n\ncat \u003c\u003c EOF | sudo tee /etc/grafana/provisioning/dashboards/all.yml\napiVersion: 1\n\nproviders:\n- name: 'default'\n  orgId: 1\n  folder: ''\n  type: file\n  disableDeletion: false\n  updateIntervalSeconds: 10 #how often Grafana will scan for changed dashboards\n  options:\n    path: /var/lib/grafana/dashboards\nEOF\n\nsudo mkdir /var/lib/grafana/dashboards\ncat \u003c\u003c EOF | sudo tee /var/lib/grafana/dashboards/Dummy_Exporter_Dashboard.json\n{\n  \"annotations\": {\n    \"list\": [\n      {\n        \"builtIn\": 1,\n        \"datasource\": \"-- Grafana --\",\n        \"enable\": true,\n        \"hide\": true,\n        \"iconColor\": \"rgba(0, 211, 255, 1)\",\n        \"name\": \"Annotations \u0026 Alerts\",\n        \"type\": \"dashboard\"\n      }\n    ]\n  },\n  \"editable\": true,\n  \"gnetId\": null,\n  \"graphTooltip\": 0,\n  \"links\": [],\n  \"panels\": [\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 0\n      },\n      \"id\": 4,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_errors[2m])\",\n          \"format\": \"time_series\",\n          \"hide\": false,\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of errors per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    },\n    {\n      \"aliasColors\": {},\n      \"bars\": false,\n      \"dashLength\": 10,\n      \"dashes\": false,\n      \"fill\": 1,\n      \"gridPos\": {\n        \"h\": 10,\n        \"w\": 24,\n        \"x\": 0,\n        \"y\": 10\n      },\n      \"id\": 2,\n      \"legend\": {\n        \"avg\": false,\n        \"current\": false,\n        \"max\": false,\n        \"min\": false,\n        \"show\": true,\n        \"total\": false,\n        \"values\": false\n      },\n      \"lines\": true,\n      \"linewidth\": 1,\n      \"links\": [],\n      \"nullPointMode\": \"null\",\n      \"percentage\": false,\n      \"pointradius\": 5,\n      \"points\": false,\n      \"renderer\": \"flot\",\n      \"seriesOverrides\": [],\n      \"spaceLength\": 10,\n      \"stack\": false,\n      \"steppedLine\": false,\n      \"targets\": [\n        {\n          \"expr\": \"rate(DummyService_requests[2m])\",\n          \"format\": \"time_series\",\n          \"intervalFactor\": 1,\n          \"refId\": \"A\"\n        }\n      ],\n      \"thresholds\": [],\n      \"timeFrom\": null,\n      \"timeRegions\": [],\n      \"timeShift\": null,\n      \"title\": \"Number of requests per sec\",\n      \"tooltip\": {\n        \"shared\": true,\n        \"sort\": 0,\n        \"value_type\": \"individual\"\n      },\n      \"type\": \"graph\",\n      \"xaxis\": {\n        \"buckets\": null,\n        \"mode\": \"time\",\n        \"name\": null,\n        \"show\": true,\n        \"values\": []\n      },\n      \"yaxes\": [\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        },\n        {\n          \"format\": \"short\",\n          \"label\": null,\n          \"logBase\": 1,\n          \"max\": null,\n          \"min\": null,\n          \"show\": true\n        }\n      ],\n      \"yaxis\": {\n        \"align\": false,\n        \"alignLevel\": null\n      }\n    }\n  ],\n  \"schemaVersion\": 16,\n  \"style\": \"dark\",\n  \"tags\": [],\n  \"templating\": {\n    \"list\": []\n  },\n  \"time\": {\n    \"from\": \"now-15m\",\n    \"to\": \"now\"\n  },\n  \"timepicker\": {\n    \"refresh_intervals\": [\n      \"5s\",\n      \"10s\",\n      \"30s\",\n      \"1m\",\n      \"5m\",\n      \"15m\",\n      \"30m\",\n      \"1h\",\n      \"2h\",\n      \"1d\"\n    ],\n    \"time_options\": [\n      \"5m\",\n      \"15m\",\n      \"1h\",\n      \"6h\",\n      \"12h\",\n      \"24h\",\n      \"2d\",\n      \"7d\",\n      \"30d\"\n    ]\n  },\n  \"timezone\": \"\",\n  \"title\": \"Dummy Exporter Dashboard\",\n  \"uid\": \"MX74Y8Qik\",\n  \"version\": 1\n}\n\nEOF\n\nsudo systemctl restart grafana-server.service\n\n\n# Register in consul\ncat \u003c\u003c EOF | sudo tee /etc/consul.d/grafana.json\n{\n  \"service\": {\n    \"name\": \"grafana\",\n    \"id\": \"grafana\",\n    \"port\": 3000,\n    \"check\": {\n      \"name\": \"grafana port 3000 http check\",\n      \"interval\": \"5s\",\n      \"http\": \"http://localhost:3000\"\n    }\n  }\n}\n\nEOF\n\nsudo systemctl reload consul\n",
                            "vars.%": "1",
                            "vars.prom_priv_ip": "10.0.1.135"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                }
            },
            "depends_on": []
        }
    ]
}
